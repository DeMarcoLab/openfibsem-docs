
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the OpenFIBSEM Project">
      
      
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.44">
    
    
      
        <title>Case Study - Serial Liftout - OpenFIBSEM Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#case-study-serial-liftout" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OpenFIBSEM Documentation" class="md-header__button md-logo" aria-label="OpenFIBSEM Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OpenFIBSEM Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Case Study - Serial Liftout
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="deep-purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/DeMarcoLab/fibsem" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    DeMarcoLab/fibsem
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
    
  
  OpenFIBSEM

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../openfibsem/" class="md-tabs__link">
          
  
    
  
  OpenFIBSEM API

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../" class="md-tabs__link">
          
  
    
  
  AutoLamella

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../blog/" class="md-tabs__link">
          
  
    
  
  Blog

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OpenFIBSEM Documentation" class="md-nav__button md-logo" aria-label="OpenFIBSEM Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    OpenFIBSEM Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/DeMarcoLab/fibsem" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    DeMarcoLab/fibsem
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    OpenFIBSEM
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            OpenFIBSEM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../openfibsem/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    OpenFIBSEM API
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            OpenFIBSEM API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openfibsem/getting_started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openfibsem/installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openfibsem/concepts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Concepts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openfibsem/user_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openfibsem/examples/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Examples
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openfibsem/roadmap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Roadmap
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openfibsem/reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    AutoLamella
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            AutoLamella
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting_started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../walkthrough/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Walkthrough
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../motivation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Motivation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../user_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ml/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Machine Learning
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../blog/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#autolamella-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      AutoLamella Implementation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgement" class="md-nav__link">
    <span class="md-ellipsis">
      Acknowledgement
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    <span class="md-ellipsis">
      Getting Started
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting Started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connecting-to-the-microscope" class="md-nav__link">
    <span class="md-ellipsis">
      Connecting to the Microscope
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terminology" class="md-nav__link">
    <span class="md-ellipsis">
      Terminology
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Terminology">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#beam-coincidence" class="md-nav__link">
    <span class="md-ellipsis">
      Beam Coincidence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flat-to-beam" class="md-nav__link">
    <span class="md-ellipsis">
      Flat to Beam
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#movement-modes" class="md-nav__link">
    <span class="md-ellipsis">
      Movement Modes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#microscope-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Microscope Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocol" class="md-nav__link">
    <span class="md-ellipsis">
      Protocol
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#serial-liftout-dataset-and-model" class="md-nav__link">
    <span class="md-ellipsis">
      Serial Liftout Dataset and Model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#serial-liftout-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Serial Liftout Workflow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Serial Liftout Workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#preparatory-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Preparatory Steps
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Preparatory Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#available-via-user-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Available via User Interface
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-1-prepare-manipulator" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1 - Prepare Manipulator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-3-clip-and-load-the-receiver-grid" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2, 3 - Clip and Load the Receiver Grid
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-copper-block-attachment" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4 - Copper Block Attachment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-prepare-the-receiver-grid" class="md-nav__link">
    <span class="md-ellipsis">
      Step 5 - Prepare the Receiver Grid
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trench-milling" class="md-nav__link">
    <span class="md-ellipsis">
      Trench Milling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Trench Milling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#steps-1-6-manual-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Steps 1 - 6 Manual Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-7-low-magnification-high-resolution-image-at-sem" class="md-nav__link">
    <span class="md-ellipsis">
      Step 7 - Low Magnification, High Resolution Image at SEM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-8-platinum-deposition" class="md-nav__link">
    <span class="md-ellipsis">
      Step 8 - Platinum Deposition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-9-low-magnification-high-resolution-image-post-platinum-deposition" class="md-nav__link">
    <span class="md-ellipsis">
      Step 9 - Low Magnification, High Resolution Image Post platinum deposition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#steps-10-11-correlation" class="md-nav__link">
    <span class="md-ellipsis">
      Steps 10 - 11 Correlation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-12-move-to-trench-milling-orientation" class="md-nav__link">
    <span class="md-ellipsis">
      Step 12 - Move to Trench Milling Orientation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-13-align-reference-image" class="md-nav__link">
    <span class="md-ellipsis">
      Step 13 - Align Reference Image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-14-align-features-coincident" class="md-nav__link">
    <span class="md-ellipsis">
      Step 14 - Align Features Coincident
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-14-region-of-interest" class="md-nav__link">
    <span class="md-ellipsis">
      Step 14 - Region of Interest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-15-trench-milling" class="md-nav__link">
    <span class="md-ellipsis">
      Step 15 - Trench Milling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-16-acquire-reference-image" class="md-nav__link">
    <span class="md-ellipsis">
      Step 16 - Acquire Reference Image
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#liftout" class="md-nav__link">
    <span class="md-ellipsis">
      Liftout
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Liftout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#steps-1-5-manual-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Steps 1 - 5 Manual Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-6-restore-milling-state" class="md-nav__link">
    <span class="md-ellipsis">
      Step 6 - Restore Milling State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-7-align-coincidence" class="md-nav__link">
    <span class="md-ellipsis">
      Step 7 - Align Coincidence
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 7 - Align Coincidence">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-8-remove-contamination-from-manipulator" class="md-nav__link">
    <span class="md-ellipsis">
      Step 8 - Remove contamination from manipulator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-9-insert-the-manipulator" class="md-nav__link">
    <span class="md-ellipsis">
      Step 9 - Insert the Manipulator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-10-move-the-manipulator-to-make-contact" class="md-nav__link">
    <span class="md-ellipsis">
      Step 10 - Move the manipulator to make contact
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-11-attach-the-copper-block-to-the-volume" class="md-nav__link">
    <span class="md-ellipsis">
      Step 11 - Attach the Copper Block to the Volume
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-12-14-sever-the-volume-block" class="md-nav__link">
    <span class="md-ellipsis">
      Step 12 - 14 - Sever the Volume Block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-15-extract-the-volume-from-the-trench" class="md-nav__link">
    <span class="md-ellipsis">
      Step 15 - Extract the Volume from the trench
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-16-17-retract-the-manipulator" class="md-nav__link">
    <span class="md-ellipsis">
      Step 16 - 17 - Retract the manipulator
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#landing" class="md-nav__link">
    <span class="md-ellipsis">
      Landing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Landing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-setup-stage" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1 - Setup Stage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-move-to-landing-orientation" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2 - Move to Landing Orientation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-setup-landing-positions" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3 - Setup Landing Positions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-move-to-landing-position" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4 - Move to Landing Position
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-insert-manipulator" class="md-nav__link">
    <span class="md-ellipsis">
      Step 5 - Insert Manipulator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-6-" class="md-nav__link">
    <span class="md-ellipsis">
      Step 6 -
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-7-position-extraction-volume" class="md-nav__link">
    <span class="md-ellipsis">
      Step 7 - Position Extraction Volume
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-8-lower-extraction-volume" class="md-nav__link">
    <span class="md-ellipsis">
      Step 8 - Lower Extraction Volume
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-9-landing-attachment" class="md-nav__link">
    <span class="md-ellipsis">
      Step 9 - Landing Attachment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-10-move-manipulator" class="md-nav__link">
    <span class="md-ellipsis">
      Step 10 - Move Manipulator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-11-release-section" class="md-nav__link">
    <span class="md-ellipsis">
      Step 11 - Release Section
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-12-validate-release" class="md-nav__link">
    <span class="md-ellipsis">
      Step 12 - Validate Release
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-13-move-manipulator-up" class="md-nav__link">
    <span class="md-ellipsis">
      Step 13 - Move Manipulator Up
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-14-retract-manipulator" class="md-nav__link">
    <span class="md-ellipsis">
      Step 14 - Retract Manipulator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-15-repeat" class="md-nav__link">
    <span class="md-ellipsis">
      Step 15 - Repeat
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-thinning" class="md-nav__link">
    <span class="md-ellipsis">
      Section Thinning
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="case-study-serial-liftout">Case Study - Serial Liftout</h1>
<p>The following is a walkthrough of implementing the serial liftout method in AutoLamella. It is based on the supplementary of the Serial Liftout paper <a href="https://www.nature.com/articles/s41592-023-02113-5#Sec27">Step-by-Step Towards Successful Serial Lift-Out</a></p>
<h2 id="autolamella-implementation">AutoLamella Implementation</h2>
<p>This is based on our current implementation of Serial Liftout in AutoLamella. This implementation is still in development, but you can try this in the AutoLiftout UI by selecting the autolamella/protocol-serial-liftout.yaml protocol, or selecting the autolamella-serial-liftout method and configuring your protocol in the user interface.</p>
<p>The current implementation in AutoLamella is slightly different than this example, due to additional experiment management integrations, logging and user interface interaction. But this should illustrate how you can use openfibsem, and the tools developed for other autolamella methods, to quickly implement a new method.</p>
<p>The specific workflow code is located:</p>
<ul>
<li>Core: autolamella/workflows/core.py</li>
<li>Serial Liftout: autolamella/workflows/serial.py</li>
</ul>
<p>If you want to try out this implementation workflow feel free, and if you would like any assistance please contact Patrick on Github (@patrickcleeve2) or via <a href="mailto:patrick@openfibsem.org">email</a>.</p>
<h2 id="acknowledgement">Acknowledgement</h2>
<p>This implementation would not have been possible without discussions and data from Oda and Sven at MPI. </p>
<h2 id="getting-started">Getting Started</h2>
<p>For information on how to configure your microscope for use with openfibsem, please see <a href="../../openfibsem/getting_started/">Getting Started</a></p>
<h3 id="connecting-to-the-microscope">Connecting to the Microscope</h3>
<p>Once you have configured your microscope, you should be able to sucessfully connect using your configuration.</p>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">from</span> <span class="nn">fibsem</span> <span class="kn">import</span> <span class="n">utils</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="c1"># connect to microscope</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">setup_session</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="s2">&quot;path/to/configuration.yaml&quot;</span><span class="p">,</span> 
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>                                            <span class="n">protocol_path</span><span class="o">=</span><span class="s2">&quot;path/to/protocol-serial-liftout.yaml&quot;</span><span class="p">)</span>
</span></code></pre></div>
The microscope object is the client connection to the microscope server, and settings is the configured settings of the microscope, for example the default imaging settings are available with settings.image.</p>
<p>You can access the protocol dictionary from settings.protocol.</p>
<h2 id="terminology">Terminology</h2>
<p>We will use the following terminology in this guide. Please see the <a href="../../openfibsem/concepts/">Concepts Page</a> for additional information.</p>
<h3 id="beam-coincidence">Beam Coincidence</h3>
<p>Beam coincidence refers to when the same feature is centred in both beams. Practically there will always be a small shift, but we want to minimise this where possible. Eucentric height is also refered to, as the position of the stage such that features stay in the same position when the stage is tilted.</p>
<h3 id="flat-to-beam">Flat to Beam</h3>
<p>When the stage is flat to a beam (e.g. flat to the electron beam) it is perpendicular to the imaging plane. Based on the microscope configuration (manufactuer, stage, and shuttle pre-tilt), we calculate the orientation required (rotation, and tilt) to move the stage to these positions. In the serial liftout appendix, the positions are given for a 45 deg shuttle-pre-tilt, and the term relative rotation is used. These map to the following flat to beam positions.</p>
<ul>
<li>Flat to Electron Beam: 0 relative rotation,  shuttle-pre-tilt deg tilt</li>
<li>Flat to Ion Beam: 180deg relative rotation, 52 - shuttle-pre-tilt deg tilt</li>
</ul>
<h3 id="movement-modes">Movement Modes</h3>
<p>We use several movement methods in openfibsem, that make automation much easier as they assist with maintaining coincidence, restore coincidence, and correcting for the imaging perspective. These are:</p>
<ul>
<li>Stable Movement (Stage): Stable movements move along the sample plane, and maintain the coincidence of the beams. They correct for the stage tilt, shuttle pre-tilt and the imaging perspective.</li>
<li>Vertical Movement (Stage): Vertical movements move the stage vertically in the chamber, corrected for the stage tilt, pre-tilt and imaging perspective. They are used to realign beam coincidence (i.e. align ion to electron).</li>
<li>Corrected Movement (Manipulator): Corrected manipulator movements move only single axes at a time. The axes correspond to the imaging perspectives. Electron beam x and y directions map to the x, y axes and the Ion Beam x and y directions map to the x, and z axes. This allows you to move a single manipulator axes, without moving its position in the other beam.</li>
</ul>
<p>As these movements all correct for the imaging perspective, they also take the beam type as a parameter. The beam type is where the imaging perspective correction is calculated from. Imaging perspective refers to the distortion when the imaging plane is not parallel to the sample plane. For example, imaging in the ion beam when the sample is flat to the electron beam causes a perspective distortion.</p>
<h3 id="microscope-configuration">Microscope Configuration</h3>
<p>The microscope configuration refers to how the microscope is initially configured, including specifying metatdata about the manufacturer, hardware and settings used.</p>
<h3 id="protocol">Protocol</h3>
<p>The protocol refers to method specific parameters that are used to control how workflows are executed, select options, and define milling parameters.</p>
<h2 id="serial-liftout-dataset-and-model">Serial Liftout Dataset and Model</h2>
<p>The MPI team generously provided a dataset from their serial liftout experiments. From this data we have labelled ~400 images from a workflow, and trained a segmentation model.</p>
<p><div class="language-yaml highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nt">checkpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;autolamella-serial-liftout-20240107.pt&#39;</span>
</span></code></pre></div>
You can access both the dataset and model through the huggingface api. For more information on both the dataset and models, please see <a href=".ml.md">Machine Learning Page</a>.</p>
<p>We will be using examples from the dataset, and model inference throughout this guide.</p>
<h2 id="serial-liftout-workflow">Serial Liftout Workflow</h2>
<p>We will work through the explanatory protocol document, and demonstrate how we can implement the steps using the openfibsem api. We will start from the section Procedure:Preparatory Steps on page 16. This is the start of the FIBSEM operation, after sample preparation and vitrification.</p>
<p>This guide was written for a Thermo Fisher Hydra Plasma FIB, but should be general for other systems. The guide is intened more as an introduction to using openfibsem, rather than a complete automated workflow. For current implementation in the user interface, please see <a href="#autolamella-implementation">AutoLamella Implementation</a>.</p>
<h3 id="preparatory-steps">Preparatory Steps</h3>
<p>The goal of the preparatory steps is to prepare the manipulator and grids for the workflow.</p>
<h4 id="available-via-user-interface">Available via User Interface</h4>
<p>The manipulator preparation is available in AutoLiftout UI in the Tools menu. You will need to connect to the microscope, create / load an experiment and load a serial-liftout protocol before you can access it. You can find the code for preparing the manipulator in autolamella/workflows/autoliftout.py:_prepare_manipulator_serial_liftout</p>
<h4 id="step-1-prepare-manipulator">Step 1 - Prepare Manipulator</h4>
<p>In this step we have to prepare and calibrate the manipulator.  </p>
<p>A. Focus and Link Stage
Currently it is recommend to manually focus and link the stage before starting openfibsem. Once you are more confident with the system, you can restore to a saved position to automatically skip this step.</p>
<p>B. Beam Coincidence</p>
<p>To align the beams coincident, we can use the following steps:</p>
<ol>
<li>Detect a Feature in Electron Beam</li>
<li>Move the Feature the centre of in Electron Beam (Stable Movement)</li>
<li>Detect the Feature in the Ion Beam</li>
<li>Move the stage vertically to move the Feature to the centre of the Ion Beam. (Vertical Movement)</li>
</ol>
<p>We support multiple different ways of doing this coincident alignment, including manually via user input, alignment with reference images, and feature detection (ml) based alignment (discussed later). You can also perform this correction manually in the user interface by centred a feature with double click in the electron beam, then centring the same feature with alt + double click in the ion beam (to move vertically).</p>
<p>To start, we recommend you manually align the coincidence using the FIBSEM User Interface controls</p>
<ol>
<li>Double Click to centre feature in Electron Beam</li>
<li>Alt + Double Click to centre feature in Ion Beam</li>
</ol>
<p>The feature should now be centred in both beams, and you are coincident.</p>
<p>C. Move the Shuttle Down</p>
<p>We move the shuttle down to avoid the manipulator making contact with the stage. All Fibsem stage positions are in the raw coordinate system (z positive is up). This coordinate system is independent of the linked (specimen) coordinate system, which is linked to the SEM working distance.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">from</span> <span class="nn">fibsem.structures</span> <span class="kn">import</span> <span class="n">FibsemStagePosition</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="c1"># move the stage down</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">microscope</span><span class="o">.</span><span class="n">move_stage_relative</span><span class="p">(</span><span class="n">FibsemStagePosition</span><span class="p">(</span><span class="n">z</span><span class="o">=-</span><span class="mf">2e-3</span><span class="p">))</span>
</span></code></pre></div>
<p>D. Insert Manipulator</p>
<p>We insert the manipulator to examine its condition. Depending on when your system was last used and the manipulator was calibrated, this position may vary a lot. We will calibrate the manipulator in the next few steps.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># insert manipulator</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">microscope</span><span class="o">.</span><span class="n">insert_manipulator</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;PARK&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>E. Prepare Manipulator Surface</p>
<p>We mill the bottom surface of the manipulator flat to prepare for attaching the copper adaptor.</p>
<p>We can define our milling protocol as follows:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="nt">prepare-manipulator</span><span class="p">:</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="nt">application_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autolamella</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="nt">hfw</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.00015</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="nt">milling_current</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">28.0e-9</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="nt">milling_voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30000</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Rectangle</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">25.0e-6</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">    </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.50e-6</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">    </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0e-6</span><span class="w">  </span>
</span></code></pre></div>
<p>We can use the model to detect the manipulator tip, and then place our milling pattern</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># detect points in ion beam at low mag</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="mf">400e-6</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">NeedleTip</span><span class="p">()]</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="n">det</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">take_image_and_detect_features</span><span class="p">(</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="p">)</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="c1"># offset detection, so we cut into manipulator</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="n">point</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">feature_m</span>   <span class="c1"># position of feature in metres (microscope image coordinates)</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="n">point</span><span class="o">.</span><span class="n">y</span> <span class="o">-=</span> <span class="mf">5e-6</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="n">point</span><span class="o">.</span><span class="n">x</span> <span class="o">-=</span> <span class="mf">5e-6</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="c1"># get milling stages from protocol</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="n">stage</span> <span class="o">=</span> <span class="n">get_milling_stages</span><span class="p">(</span><span class="s2">&quot;prepare-manipulator&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="c1"># mill stages</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="n">milling</span><span class="o">.</span><span class="n">mill_stages</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">stages</span><span class="p">)</span>
</span></code></pre></div>
<p>F. Manipulator Calibration</p>
<p>We provide a manipulator calibration tool to assist in calibrating the EasyLift. Due to API limitations, the user still has to activate the calibration procedure in xTUI and then can follow the instructions in the tool to calibrate their EasyLift each day. The tool is available in the AutoLiftout UI via the Tools -&gt; Calibrate Manipulator menu.  The tool uses the machine learning model to calibrate the manipulator.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">from</span> <span class="nn">fibsem</span> <span class="kn">import</span> <span class="n">calibration</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="c1"># manipulator calibration</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="n">calibration</span><span class="o">.</span><span class="n">_calibrate_manipulator_thermo</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span></code></pre></div>
<p>After calibrating, we can confirm our calibration was successful, by re-inserting to the saved positions, and checking the positions.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">from</span> <span class="nn">fibsem.structures</span> <span class="kn">import</span> <span class="n">FibsemStagePosition</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="c1"># make sure you move the stage down first</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="n">microscope</span><span class="o">.</span><span class="n">move_stage_relative</span><span class="p">(</span><span class="n">FibsemStagePosition</span><span class="p">(</span><span class="n">z</span><span class="o">=-</span><span class="mf">1e-3</span><span class="p">))</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="c1"># insert to parking position (~180um above stage)</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="n">microscope</span><span class="o">.</span><span class="n">insert_manipulator</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;PARK&quot;</span><span class="p">)</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="c1"># insert to eucentric position (centre of both beams)</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="n">microscope</span><span class="o">.</span><span class="n">insert_manipulator</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;EUCENTRIC&quot;</span><span class="p">)</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="c1"># retract manipulator</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="n">microscope</span><span class="o">.</span><span class="n">retract_manipulator</span><span class="p">()</span>
</span></code></pre></div>
<h4 id="step-2-3-clip-and-load-the-receiver-grid">Step 2, 3 - Clip and Load the Receiver Grid</h4>
<p>These steps clip and and load the receiver grid into the FIBSEM. This is not something we can help with at the moment :D.</p>
<h4 id="step-4-copper-block-attachment">Step 4 - Copper Block Attachment</h4>
<p>The steps prepare the copper adaptor block, and attach it to the manipulator. Figures https://www.nature.com/articles/s41592-023-02113-5/figures/7 show the process.</p>
<p>A. Mill Copper Bar</p>
<p>We move to the milling orientation, and mill the grid bar to be ~20um thick.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nt">prepare-copper-grid</span><span class="p">:</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="nt">stages</span><span class="p">:</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">application_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autolamella</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">        </span><span class="nt">hfw</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.00015</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">        </span><span class="nt">milling_current</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">28.0e-9</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">        </span><span class="nt">milling_voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30000</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Rectangle</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">        </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100.0e-6</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">        </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.0e-6</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">        </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0e-6</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="c1"># first move flat to electron</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="n">microscope</span><span class="o">.</span><span class="n">move_flat_to_beam</span><span class="p">(</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ELECTRON</span><span class="p">)</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="c1"># move to milling angle</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="n">milling_position</span> <span class="o">=</span> <span class="n">FibsemStagePosition</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">18</span><span class="p">))</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="n">microscope</span><span class="o">.</span><span class="n">safe_absolute_stage_movement</span><span class="p">(</span><span class="n">milling_position</span><span class="p">)</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="c1"># get milling stages</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="n">stages</span> <span class="o">=</span> <span class="n">get_milling_stages</span><span class="p">(</span><span class="s2">&quot;prepare-copper-grid&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="c1"># run milling </span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="n">milling</span><span class="o">.</span><span class="n">mill_stages</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">stages</span><span class="p">)</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="c1"># save state for later return</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="n">milling_state</span> <span class="o">=</span> <span class="n">microscope</span><span class="o">.</span><span class="n">get_microscope_state</span><span class="p">()</span>
</span></code></pre></div>
<p>B. Rotate Flat to Ion</p>
<p>We rotate around flat to the ion beam.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># move flat to ion</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">microscope</span><span class="o">.</span><span class="n">move_flat_to_beam</span><span class="p">(</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span>
</span></code></pre></div>
<p>C. Mill Copper Blocks</p>
<p>We mill a series of blocks into the copper bar, leaving them attached to each other on the side.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nt">prepare-copper-blocks</span><span class="p">:</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="nt">stages</span><span class="p">:</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">application_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autolamella</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">        </span><span class="nt">hfw</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">150.0e-6</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">        </span><span class="nt">milling_current</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">28.0e-9</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">        </span><span class="nt">milling_voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30000</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">        </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0e-6</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">        </span><span class="nt">pitch_horizontal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0e-6</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">        </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20.0e-6</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">        </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0e-6</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ArrayPattern</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">        </span><span class="nt">passes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">        </span><span class="nt">n_columns</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4.0</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">        </span><span class="nt">n_rows</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">        </span><span class="nt">pitch_vertical</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">        </span><span class="nt">scan_direction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TopToBottom</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">application_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autolamella</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">        </span><span class="nt">hfw</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.00015</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">        </span><span class="nt">milling_current</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">28.0e-9</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">        </span><span class="nt">milling_voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30000</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Rectangle</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">        </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100.0e-6</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">        </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7.50e-6</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w">        </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0e-6</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">from</span> <span class="nn">fibsem</span> <span class="kn">import</span> <span class="n">utils</span><span class="p">,</span> <span class="n">acquire</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">from</span> <span class="nn">fibsem.patterning</span> <span class="kn">import</span> <span class="n">get_milling_stages</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">from</span> <span class="nn">fibsem.ui.utils</span> <span class="kn">import</span> <span class="n">_draw_milling_stages_on_image</span> 
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="kn">from</span> <span class="nn">fibsem.structures</span> <span class="kn">import</span> <span class="n">Point</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="c1"># acquire image for visualiation</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="mf">150e-6</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="n">image</span> <span class="o">=</span> <span class="n">microscope</span><span class="o">.</span><span class="n">acquire_image</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="c1"># offset for top pattern</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="n">h1</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;prepare-copper-blocks&quot;</span><span class="p">][</span><span class="s2">&quot;stages&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="n">h2</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;prepare-copper-blocks&quot;</span><span class="p">][</span><span class="s2">&quot;stages&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="n">dy</span> <span class="o">=</span> <span class="n">h1</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">h2</span><span class="o">/</span><span class="mi">2</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="n">pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="p">)]</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="c1"># get milling stages form protocol</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="n">stages</span> <span class="o">=</span> <span class="n">get_milling_stages</span><span class="p">(</span><span class="s2">&quot;prepare-copper-blocks&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">pts</span><span class="p">)</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="c1"># draw stages on image</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="n">fig</span> <span class="o">=</span> <span class="n">_draw_milling_stages_on_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">stages</span><span class="p">)</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="c1"># run milling</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="n">milling</span><span class="o">.</span><span class="n">mill_stages</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">stages</span><span class="p">)</span>
</span></code></pre></div>
<p>TODO: draw patterns</p>
<p>D. Move back to Milling Orientation</p>
<p>We restore the microscope, back to the milling orientation. If this position was coincident, it should still be coincident. Otherwise, align manually.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># we restore our previously saved milling state</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="n">microscope</span><span class="o">.</span><span class="n">set_microscope_state</span><span class="p">(</span><span class="n">milling_state</span><span class="p">)</span>
</span></code></pre></div>
<p>E. Insert Maipulator</p>
<p>We insert the manipulator, and move it onto one of the blocks. This moving is best done manually at this point.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># insert manipulator</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">microscope</span><span class="o">.</span><span class="n">insert_manipulator</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;PARK&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>F. Manipulator Contact</p>
<p>We make contact with the block face. We can run another milling stage to polish the face to ensure they are flat.</p>
<p>G. Attach the Block</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nt">prepare-copper-weld</span><span class="p">:</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="nt">stages</span><span class="p">:</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.5e-6</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">        </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5e-6</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">        </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4.0e-6</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">        </span><span class="nt">pitch_horizontal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0e-6</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">        </span><span class="nt">n_columns</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">        </span><span class="nt">n_rows</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">        </span><span class="nt">pitch_vertical</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0e-6</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">        </span><span class="nt">rotation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">        </span><span class="nt">passes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">        </span><span class="nt">milling_voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0e+3</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">        </span><span class="nt">milling_current</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300.0e-12</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">        </span><span class="nt">hfw</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">150.0e-6</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">        </span><span class="nt">application_file</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autolamella&quot;</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">        </span><span class="nt">scan_direction</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;TopToBottom&quot;</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ArrayPattern&quot;</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">        </span><span class="nt">preset</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;30</span><span class="nv"> </span><span class="s">keV;</span><span class="nv"> </span><span class="s">2.5</span><span class="nv"> </span><span class="s">nA&quot;</span>
</span></code></pre></div>
<p>H. Release the Block</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nt">prepare-copper-release</span><span class="p">:</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="nt">stages</span><span class="p">:</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">application_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">autolamella</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">        </span><span class="nt">hfw</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">150.0e-6</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">        </span><span class="nt">milling_current</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">28.0e-9</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">        </span><span class="nt">milling_voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30000</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">        </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0e-6</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">        </span><span class="nt">pitch_horizontal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0e-6</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">        </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20.0e-6</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">        </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.0e-6</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ArrayPattern</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">        </span><span class="nt">passes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">        </span><span class="nt">n_columns</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.0</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">        </span><span class="nt">n_rows</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">        </span><span class="nt">pitch_vertical</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="w">        </span><span class="nt">scan_direction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TopToBottom</span>
</span></code></pre></div>
<p>I. Remove Manipulator</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># move manipulator up</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="n">microscope</span><span class="o">.</span><span class="n">move_manipulator_corrected</span><span class="p">(</span><span class="n">dx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mf">10e-6</span><span class="p">,</span> <span class="n">beam_type</span><span class="o">=</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span>
</span></code></pre></div>
<p>J. Retract Manipulator</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># retract manipulator</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="n">microscope</span><span class="o">.</span><span class="n">retract_manipulator</span><span class="p">()</span>
</span></code></pre></div>
<h4 id="step-5-prepare-the-receiver-grid">Step 5 - Prepare the Receiver Grid</h4>
<p>We prepare for the double sided attachment.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="nt">grid-lines</span><span class="p">:</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">    </span><span class="nt">cleaning_cross_section</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.0e-05</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">    </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0e-6</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">    </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500.0e-06</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">    </span><span class="nt">hfw</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">900.0e-6</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">    </span><span class="nt">milling_voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0e+3</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">    </span><span class="nt">milling_current</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.8e-08</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">    </span><span class="nt">rotation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">    </span><span class="nt">scan_direction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TopToBottom</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">    </span><span class="nt">application_file</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autolamella&quot;</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Rectangle&quot;</span><span class="w"> </span><span class="c1"># TODO: update to Line</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># move flat to ion</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="n">microscope</span><span class="o">.</span><span class="n">move_flat_to_beam</span><span class="p">(</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="c1"># get milling stages</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="n">stages</span> <span class="o">=</span> <span class="n">get_milling_stages</span><span class="p">(</span><span class="s2">&quot;grid-lines&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="c1"># mill stages</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="n">milling</span><span class="o">.</span><span class="n">mill_stages</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">stages</span><span class="p">)</span>
</span></code></pre></div>
<p>The manipulator and grid are now prepared.</p>
<h2 id="trench-milling">Trench Milling</h2>
<h3 id="steps-1-6-manual-setup">Steps 1 - 6 Manual Setup</h3>
<p>Steps 1 through 6 involve setting up the microscope, clearing contamination, platinum deposition and image correlation. At the moment these setup steps (focus and link, decontamination) are best performed manually  or not fully supported yet (correlation).</p>
<h3 id="step-7-low-magnification-high-resolution-image-at-sem">Step 7 - Low Magnification, High Resolution Image at SEM</h3>
<p>You can use the movement and imaging api to move to the required orientations, and acquire reference images using the following:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># move to imaging orientation -&gt; flat to electron</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="n">microscope</span><span class="o">.</span><span class="n">move_flat_to_beam</span><span class="p">(</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ELECTRON</span><span class="p">)</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="c1"># set imaging parameters</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ELECTRON</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6144</span><span class="p">,</span> <span class="mi">4096</span><span class="p">]</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">dwell_time</span> <span class="o">=</span> <span class="mf">2e-6</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="mf">2000e-6</span>                            <span class="c1"># size of grid</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ref_mapping_high_res_electron&quot;</span> <span class="c1"># filename</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="c1"># acquire the image</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="n">image</span> <span class="o">=</span> <span class="n">acquire</span><span class="o">.</span><span class="n">new_image</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="step-8-platinum-deposition">Step 8 - Platinum Deposition</h3>
<p>You can use the deposition api, but it was developed for a system that had a multi-chem, I haven't been able to test it on a regular gis system. You can also access the deposition tool via the AutoLamella UI -&gt; Tools -&gt; Cryo Deposition.</p>
<p>Example cryo deposition api.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kn">from</span> <span class="nn">fibsem</span> <span class="kn">import</span> <span class="n">gis</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="c1"># define gis deposition protocol</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="n">gis_protocol</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="s2">&quot;application_file&quot;</span><span class="p">:</span> <span class="s2">&quot;cryo_Pt_dep&quot;</span><span class="p">,</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>    <span class="s2">&quot;gas&quot;</span><span class="p">:</span> <span class="s2">&quot;Pt cryo&quot;</span><span class="p">,</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="s2">&quot;cryo&quot;</span><span class="p">,</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>    <span class="s2">&quot;hfw&quot;</span><span class="p">:</span> <span class="mf">3.0e-05</span> <span class="p">,</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>    <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="mf">7.0e-06</span><span class="p">,</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>    <span class="s2">&quot;beam_current&quot;</span><span class="p">:</span> <span class="mf">1.0e-8</span><span class="p">,</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">30.0</span><span class="p">,</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="p">}</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="c1"># move to milling orientation -&gt; flat to ion</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="n">microscope</span><span class="o">.</span><span class="n">move_flat_to_beam</span><span class="p">(</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="c1"># run cryo deposition at the current stage position</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="c1"># the stage will move down by 1mm to avoid collision before sputtering.</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="n">gis</span><span class="o">.</span><span class="n">cryo_deposition</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">gis_protocol</span><span class="p">)</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="c1"># run cryo deposition at the a named stage position</span>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="c1"># You will need to define this named position through the Movement Tab (positions.yaml)</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="n">gis</span><span class="o">.</span><span class="n">cryo_deposition</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">gis_protocol</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cryo-deposition-position&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="step-9-low-magnification-high-resolution-image-post-platinum-deposition">Step 9 - Low Magnification, High Resolution Image Post platinum deposition</h3>
<p>We can also acquire images after platinum deposition.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># move to imaging orientation -&gt; flat to electron</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">microscope</span><span class="o">.</span><span class="n">move_flat_to_beam</span><span class="p">(</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ELECTRON</span><span class="p">)</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="c1"># set imaging parameters</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ELECTRON</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6144</span><span class="p">,</span> <span class="mi">4096</span><span class="p">]</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">dwell_time</span> <span class="o">=</span> <span class="mf">2e-6</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="mf">2000e-6</span>                                <span class="c1"># size of grid</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ref_mapping_high_res_electron_pt&quot;</span>  <span class="c1"># filename</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="c1"># acquire the image</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="n">image</span> <span class="o">=</span> <span class="n">acquire</span><span class="o">.</span><span class="n">new_image</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="steps-10-11-correlation">Steps 10 - 11 Correlation</h3>
<p>At the moment, correlation is best performed using external software.</p>
<p>You can acquire tilesets using the Minimap UI. It is available through the user interface -&gt; Tools -&gt; Open Minimap</p>
<h3 id="step-12-move-to-trench-milling-orientation">Step 12 - Move to Trench Milling Orientation</h3>
<p>We can move to the trench milling orientation (flat to ion beam), with the following code:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1"># move perpendicular to ion beam</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="n">microscope</span><span class="o">.</span><span class="n">move_flat_to_beam</span><span class="p">(</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="step-13-align-reference-image">Step 13 - Align Reference Image</h3>
<p>We can align the SEM reference image to the ION image with the following code.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># load reference image</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="n">ref_image</span> <span class="o">=</span> <span class="n">FibsemImage</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;path/to/reference_image.tif&quot;</span><span class="p">)</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="c1"># rotate the reference </span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="n">ref_image_electron</span> <span class="o">=</span> <span class="n">image_utils</span><span class="o">.</span><span class="n">rotate_image</span><span class="p">(</span><span class="n">ref_image_electron</span><span class="p">)</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="c1"># acquire ion image using same imaging settings</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">ImageSettings</span><span class="o">.</span><span class="n">fromFibsemImage</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="n">new_image</span> <span class="o">=</span> <span class="n">acquire</span><span class="o">.</span><span class="n">new_image</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="c1"># align reference</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="c1"># NOTE: there are additional options for masking, and changing filters available</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="n">alignment</span><span class="o">.</span><span class="n">align_using_reference_images</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">ref_image</span><span class="p">,</span> <span class="n">new_image</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="step-14-align-features-coincident">Step 14 - Align Features Coincident</h3>
<p>To align the beams to the feature of interest is coincident, we can use the following steps:</p>
<ol>
<li>Detect a Feature in Electron Beam</li>
<li>Move the Feature the centre of in Electron Beam (Stable Movement)</li>
<li>Detect the Feature in the Ion Beam</li>
<li>Move the stage vertically to move the Feature to the centre of the Ion Beam. (Vertical Movement)</li>
</ol>
<p>We support multiple different ways of doing this coincident alignment, including manually via user input, alignment with reference images, and feature detection (ml) based alignment (discussed later). You can also perform this correction manually in the user interface by centred a feature with double click in the electron beam, then centring the same feature with alt + double click in the ion beam (to move vertically).</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># example: pseudocode</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="c1"># we are flat to the ion and want to rotate around 180 to be flat to the electron. then we need to re-align coincidence.</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="c1"># assuming the beams were coincident prior to a rotation. We can take reference images before rotation, then cross align them after rotation to restore coincidence. </span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="c1"># this is just pseudo code, real examples require more tuning and parameters to make it work repeatedly. For this reason, we prefer using the ml version.</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="c1"># acquire reference images</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="n">ref_image_electron</span><span class="p">,</span> <span class="n">ref_image_ion</span> <span class="o">=</span> <span class="n">acquire</span><span class="o">.</span><span class="n">take_reference_images</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="c1"># rotate flat to electorn</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="n">microscope</span><span class="o">.</span><span class="n">move_flat_to_beam</span><span class="p">(</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ELECTRON</span><span class="p">)</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="c1"># acquire new images</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="n">new_image_electron</span><span class="p">,</span> <span class="n">new_image_ion</span> <span class="o">=</span> <span class="n">acquire</span><span class="o">.</span><span class="n">take_reference_images</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="c1"># rotate references</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="n">ref_image_electron</span> <span class="o">=</span> <span class="n">image_utils</span><span class="o">.</span><span class="n">rotate_image</span><span class="p">(</span><span class="n">ref_image_electron</span><span class="p">)</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="n">ref_image_ion</span> <span class="o">=</span> <span class="n">image_utils</span><span class="o">.</span><span class="n">rotate_image</span><span class="p">(</span><span class="n">ref_image_ion</span><span class="p">)</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="c1"># stable movement (step 1, 2)</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="n">alignment</span><span class="o">.</span><span class="n">align_using_reference_images</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">ref_image_1</span><span class="p">,</span> <span class="n">new_image_1</span><span class="p">)</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="c1"># vertical movement (step 3, 4)</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="n">alignment</span><span class="o">.</span><span class="n">align_using_reference_images</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">ref_image_2</span><span class="p">,</span> <span class="n">new_image_2</span><span class="p">,</span> <span class="n">constrain_vertical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="c1"># the beams should now be coincident again. </span>
</span></code></pre></div>
<h3 id="step-14-region-of-interest">Step 14 - Region of Interest</h3>
<p>The region of interest is determined manually. Once the stage is moved to the correct position, we can save the state of the microscope with the following code:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># save trench milling position</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">milling_state</span> <span class="o">=</span> <span class="n">microscope</span><span class="o">.</span><span class="n">get_microscope_state</span><span class="p">()</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="c1"># we can restore back to this position / state at any time using:</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="n">microscope</span><span class="o">.</span><span class="n">set_microscope_state</span><span class="p">(</span><span class="n">milling_state</span><span class="p">)</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="c1"># we can also save the state to file, to be reloaded later</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="n">utils</span><span class="o">.</span><span class="n">save_yaml</span><span class="p">(</span><span class="s2">&quot;path/to/milling_state.yaml&quot;</span><span class="p">,</span> <span class="n">milling_state</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span></code></pre></div>
<h3 id="step-15-trench-milling">Step 15 - Trench Milling</h3>
<p>We can define the trench milling protocol as follows, we use a two stage milling protocol. The first stage mills the large trenches at high current, and the second polishes the contact surface.</p>
<div class="language-yaml highlight"><span class="filename">protocol-serial-liftout.yaml</span><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="nt">trench</span><span class="p">:</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">    </span><span class="nt">stages</span><span class="p">:</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">25.0e-6</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">        </span><span class="nt">hfw</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">400e-06</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">        </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">180.0e-06</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">        </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4.5e-05</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">        </span><span class="nt">milling_voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0e+3</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">        </span><span class="nt">milling_current</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.0e-9</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">        </span><span class="nt">rotation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">        </span><span class="nt">scan_direction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TopToBottom</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">        </span><span class="nt">side_trench_width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.0e-06</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="w">        </span><span class="nt">top_trench_height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0e-6</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">        </span><span class="nt">application_file</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autolamella&quot;</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;HorseshoeVertical&quot;</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="w">        </span><span class="nt">preset</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;30</span><span class="nv"> </span><span class="s">keV;</span><span class="nv"> </span><span class="s">20</span><span class="nv"> </span><span class="s">nA&quot;</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">25.0e-6</span>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="w">        </span><span class="nt">hfw</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8.0e-05</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="w">        </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.5e-06</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="w">        </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4.5e-05</span>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="w">        </span><span class="nt">milling_voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0e+3</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="w">        </span><span class="nt">milling_current</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300.0e-12</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="w">        </span><span class="nt">rotation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="w">        </span><span class="nt">scan_direction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TopToBottom</span>
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="w">        </span><span class="nt">application_file</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autolamella&quot;</span>
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Rectangle&quot;</span>
</span></code></pre></div>
<p>We can then run the trench milling with the following code.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kn">from</span> <span class="nn">fibsem</span> <span class="kn">import</span> <span class="n">milling</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="kn">from</span> <span class="nn">fibsem.patterning</span> <span class="kn">import</span> <span class="n">get_milling_stages</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="c1"># move the polishing pattern to the top of the volume block</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="n">polishing_offset</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;trench&quot;</span><span class="p">][</span><span class="s2">&quot;stages&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="c1"># get milling stages from the protocol</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="n">stages</span> <span class="o">=</span> <span class="n">get_milling_stages</span><span class="p">(</span><span class="s2">&quot;trench&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">polishing_offset</span><span class="p">])</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="c1"># run milling operations</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="n">milling</span><span class="o">.</span><span class="n">mill_stages</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">stages</span><span class="p">)</span>
</span></code></pre></div>
<p>We can also draw the milling stages on an image to see them before milling.
<div class="language-python highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kn">from</span> <span class="nn">fibsem.ui.utils</span> <span class="kn">import</span> <span class="n">_draw_milling_stages_on_image</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="c1"># acquire image</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="mf">400e-6</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="n">image</span> <span class="o">=</span> <span class="n">acquire</span><span class="o">.</span><span class="n">new_image</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="c1"># draw milling stages</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="n">fig</span> <span class="o">=</span> <span class="n">_draw_milling_stages_on_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">stages</span><span class="p">)</span>
</span></code></pre></div></p>
<h3 id="step-16-acquire-reference-image">Step 16 - Acquire Reference Image</h3>
<p>We can acquire the final trench reference images with the following code.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="c1"># move to imaging orientation -&gt; flat to electron</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="n">microscope</span><span class="o">.</span><span class="n">move_flat_to_beam</span><span class="p">(</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ELECTRON</span><span class="p">)</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="c1"># set imaging parameters</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ELECTRON</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6144</span><span class="p">,</span> <span class="mi">4096</span><span class="p">]</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">dwell_time</span> <span class="o">=</span> <span class="mf">2e-6</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="mf">2000e-6</span>                                <span class="c1"># size of grid</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ref_trench_milling_final&quot;</span>          <span class="c1"># filename</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="c1"># acquire the image</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="n">image</span> <span class="o">=</span> <span class="n">acquire</span><span class="o">.</span><span class="n">new_image</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="liftout">Liftout</h2>
<p>The liftout steps attach the volume block to the manipulator, and extract it from the rest of the sample bulk.</p>
<h3 id="steps-1-5-manual-setup">Steps 1 - 5 Manual Setup</h3>
<p>Similar to Trench milling, steps 1 to 5 should be completed manually.</p>
<h3 id="step-6-restore-milling-state">Step 6 - Restore Milling State</h3>
<p>We can restore our previously saved milling position / state.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="c1"># load milling state from disk</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="n">milling_state</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load_yaml</span><span class="p">(</span><span class="s2">&quot;path/to/milling_state.yaml&quot;</span><span class="p">)</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="c1"># restore microscope state</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="n">microscope</span><span class="o">.</span><span class="n">set_microscope_state</span><span class="p">(</span><span class="n">milling_state</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="step-7-align-coincidence">Step 7 - Align Coincidence</h3>
<p>Now that we have a feature the model is trained for, we can use it to detect the feature (Volume Block) and align it in both beams to set the coincidence.</p>
<p>We wrapped this up in a helper function, so we can re use it for any feature:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="c1"># select feature</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="n">feature</span> <span class="o">=</span> <span class="n">VolumeBlockBottomEdge</span><span class="p">()</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="c1"># align feature so beams are coincident</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="n">lamella</span> <span class="o">=</span> <span class="n">align_feature_coincident</span><span class="p">(</span><span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span> 
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>                            <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span> 
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>                            <span class="n">hfw</span><span class="o">=</span><span class="mf">400e-6</span><span class="p">,</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>                            <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">)</span>
</span></code></pre></div>
<p>The pseudo code for this function is below. The implemented function (with ui integration) is found in autolamella/workflows/core:align_feature_coincident</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">def</span> <span class="nf">align_feature_coincident</span><span class="p">(</span><span class="n">microscope</span><span class="p">:</span> <span class="n">FibsemMicroscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">MicroscopeSettings</span><span class="p">,</span> 
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>                              <span class="n">hfw</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">fcfg</span><span class="o">.</span><span class="n">REFERENCE_HFW_MEDIUM</span><span class="p">,</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>                              <span class="n">feature</span><span class="p">:</span> <span class="n">Feature</span> <span class="o">=</span> <span class="n">LamellaCentre</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">Lamella</span><span class="p">:</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Align the feature in the electron and ion beams to be coincident.&quot;&quot;&quot;</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>    <span class="c1"># bookkeeping</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature</span><span class="p">]</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>    <span class="c1"># detect and align in electron</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>    <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="n">hfw</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>    <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ELECTRON</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>    <span class="n">det</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">take_image_and_detect_features</span><span class="p">(</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a>        <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a>        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>        <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a>    <span class="p">)</span>
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a>    <span class="n">microscope</span><span class="o">.</span><span class="n">stable_move</span><span class="p">(</span>
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a>        <span class="n">dx</span><span class="o">=</span><span class="n">det</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">feature_m</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
</span><span id="__span-34-19"><a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a>        <span class="n">dy</span><span class="o">=</span><span class="n">det</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">feature_m</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
</span><span id="__span-34-20"><a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a>        <span class="n">beam_type</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span>
</span><span id="__span-34-21"><a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a>    <span class="p">)</span>
</span><span id="__span-34-22"><a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a>
</span><span id="__span-34-23"><a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a>    <span class="c1"># Align ion so it is coincident with the electron beam</span>
</span><span id="__span-34-24"><a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a>    <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span>
</span><span id="__span-34-25"><a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a>    <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="n">hfw</span>
</span><span id="__span-34-26"><a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a>
</span><span id="__span-34-27"><a id="__codelineno-34-27" name="__codelineno-34-27" href="#__codelineno-34-27"></a>    <span class="n">det</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">take_image_and_detect_features</span><span class="p">(</span>
</span><span id="__span-34-28"><a id="__codelineno-34-28" name="__codelineno-34-28" href="#__codelineno-34-28"></a>        <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-34-29"><a id="__codelineno-34-29" name="__codelineno-34-29" href="#__codelineno-34-29"></a>        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-34-30"><a id="__codelineno-34-30" name="__codelineno-34-30" href="#__codelineno-34-30"></a>        <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="__span-34-31"><a id="__codelineno-34-31" name="__codelineno-34-31" href="#__codelineno-34-31"></a>    <span class="p">)</span>
</span><span id="__span-34-32"><a id="__codelineno-34-32" name="__codelineno-34-32" href="#__codelineno-34-32"></a>    <span class="c1"># align vertical</span>
</span><span id="__span-34-33"><a id="__codelineno-34-33" name="__codelineno-34-33" href="#__codelineno-34-33"></a>    <span class="n">microscope</span><span class="o">.</span><span class="n">vertical_move</span><span class="p">(</span>
</span><span id="__span-34-34"><a id="__codelineno-34-34" name="__codelineno-34-34" href="#__codelineno-34-34"></a>        <span class="n">dx</span><span class="o">=</span><span class="n">det</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">feature_m</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
</span><span id="__span-34-35"><a id="__codelineno-34-35" name="__codelineno-34-35" href="#__codelineno-34-35"></a>        <span class="n">dy</span><span class="o">=-</span><span class="n">det</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">feature_m</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
</span><span id="__span-34-36"><a id="__codelineno-34-36" name="__codelineno-34-36" href="#__codelineno-34-36"></a>    <span class="p">)</span>
</span><span id="__span-34-37"><a id="__codelineno-34-37" name="__codelineno-34-37" href="#__codelineno-34-37"></a>
</span><span id="__span-34-38"><a id="__codelineno-34-38" name="__codelineno-34-38" href="#__codelineno-34-38"></a>    <span class="c1"># reference images</span>
</span><span id="__span-34-39"><a id="__codelineno-34-39" name="__codelineno-34-39" href="#__codelineno-34-39"></a>    <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-34-40"><a id="__codelineno-34-40" name="__codelineno-34-40" href="#__codelineno-34-40"></a>    <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="n">hfw</span>
</span><span id="__span-34-41"><a id="__codelineno-34-41" name="__codelineno-34-41" href="#__codelineno-34-41"></a>    <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ref_</span><span class="si">{</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_align_coincident_final&quot;</span>
</span><span id="__span-34-42"><a id="__codelineno-34-42" name="__codelineno-34-42" href="#__codelineno-34-42"></a>    <span class="n">eb_image</span><span class="p">,</span> <span class="n">ib_image</span> <span class="o">=</span> <span class="n">acquire</span><span class="o">.</span><span class="n">take_reference_images</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="__span-34-43"><a id="__codelineno-34-43" name="__codelineno-34-43" href="#__codelineno-34-43"></a>
</span><span id="__span-34-44"><a id="__codelineno-34-44" name="__codelineno-34-44" href="#__codelineno-34-44"></a>    <span class="k">return</span>
</span></code></pre></div>
<h4 id="step-8-remove-contamination-from-manipulator">Step 8 - Remove contamination from manipulator</h4>
<p>It is recommended to mill away any contaminants that would have accumulated during storage.</p>
<h4 id="step-9-insert-the-manipulator">Step 9 - Insert the Manipulator</h4>
<p>Insert the manipulator to the park position</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="n">microscope</span><span class="o">.</span><span class="n">insert_manipulator</span><span class="p">(</span><span class="s2">&quot;PARK&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="step-10-move-the-manipulator-to-make-contact">Step 10 - Move the manipulator to make contact</h4>
<p>We now need to guide the manipulator to make contact with the surface. We first align the features in the electron beam, and then in the ion. We iteratively align the manipulator using the Ion beam to ensure good contact.</p>
<p>Note: The current serial liftout dataset doesn't have many images from this part of the workflow, so it will likely perform poorly. If you would like to contribute data for this part (or any part of the workflow), please contact patrick@openfibsem.org.</p>
<p>We use the helper function move_based_on_detection to apply the correct transformations to move the desired system (in this case the manipulator) based on the detected features.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>    <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ELECTRON</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>    <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="mf">400e-6</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>    <span class="c1"># DETECT COPPER ADAPTER, VOLUME TOP</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>    <span class="n">scan_rotation</span> <span class="o">=</span> <span class="n">microscope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scan_rotation&quot;</span><span class="p">,</span> <span class="n">beam_type</span><span class="o">=</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">CopperAdapterTopEdge</span><span class="p">(),</span> <span class="n">VolumeBlockBottomEdge</span><span class="p">()]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">scan_rotation</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">CopperAdapterBottomEdge</span><span class="p">(),</span> <span class="n">VolumeBlockTopEdge</span><span class="p">()]</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>    <span class="n">det</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">take_image_and_detect_features</span><span class="p">(</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>        <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>        <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a>    <span class="p">)</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>    <span class="c1"># MOVE TO VOLUME BLOCK TOP</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a>    <span class="n">detection</span><span class="o">.</span><span class="n">move_based_on_detection</span><span class="p">(</span>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a>        <span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">beam_type</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span><span class="p">,</span> <span class="n">move_x</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a>         <span class="n">_move_system</span><span class="o">=</span><span class="s2">&quot;manipulator&quot;</span>
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a>    <span class="p">)</span>
</span><span id="__span-36-18"><a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a>
</span><span id="__span-36-19"><a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a>    <span class="c1"># align manipulator to top of lamella in ion x3</span>
</span><span id="__span-36-20"><a id="__codelineno-36-20" name="__codelineno-36-20" href="#__codelineno-36-20"></a>    <span class="n">HFWS</span> <span class="o">=</span> <span class="p">[</span><span class="mf">400e-6</span><span class="p">,</span> <span class="mf">150e-6</span><span class="p">,</span> <span class="mf">80e-6</span><span class="p">]</span>
</span><span id="__span-36-21"><a id="__codelineno-36-21" name="__codelineno-36-21" href="#__codelineno-36-21"></a>
</span><span id="__span-36-22"><a id="__codelineno-36-22" name="__codelineno-36-22" href="#__codelineno-36-22"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hfw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">HFWS</span><span class="p">):</span>
</span><span id="__span-36-23"><a id="__codelineno-36-23" name="__codelineno-36-23" href="#__codelineno-36-23"></a>
</span><span id="__span-36-24"><a id="__codelineno-36-24" name="__codelineno-36-24" href="#__codelineno-36-24"></a>
</span><span id="__span-36-25"><a id="__codelineno-36-25" name="__codelineno-36-25" href="#__codelineno-36-25"></a>        <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span>
</span><span id="__span-36-26"><a id="__codelineno-36-26" name="__codelineno-36-26" href="#__codelineno-36-26"></a>        <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="n">hfw</span>
</span><span id="__span-36-27"><a id="__codelineno-36-27" name="__codelineno-36-27" href="#__codelineno-36-27"></a>
</span><span id="__span-36-28"><a id="__codelineno-36-28" name="__codelineno-36-28" href="#__codelineno-36-28"></a>        <span class="c1"># DETECT COPPER ADAPTER, LAMELLA TOP</span>
</span><span id="__span-36-29"><a id="__codelineno-36-29" name="__codelineno-36-29" href="#__codelineno-36-29"></a>        <span class="n">scan_rotation</span> <span class="o">=</span> <span class="n">microscope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scan_rotation&quot;</span><span class="p">,</span> <span class="n">beam_type</span><span class="o">=</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span>
</span><span id="__span-36-30"><a id="__codelineno-36-30" name="__codelineno-36-30" href="#__codelineno-36-30"></a>        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">CopperAdapterTopEdge</span><span class="p">(),</span> <span class="n">VolumeBlockBottomEdge</span><span class="p">()]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">scan_rotation</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">CopperAdapterBottomEdge</span><span class="p">(),</span> <span class="n">VolumeBlockTopEdge</span><span class="p">()]</span>
</span><span id="__span-36-31"><a id="__codelineno-36-31" name="__codelineno-36-31" href="#__codelineno-36-31"></a>
</span><span id="__span-36-32"><a id="__codelineno-36-32" name="__codelineno-36-32" href="#__codelineno-36-32"></a>        <span class="n">det</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">take_image_and_detect_features</span><span class="p">(</span>
</span><span id="__span-36-33"><a id="__codelineno-36-33" name="__codelineno-36-33" href="#__codelineno-36-33"></a>            <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-36-34"><a id="__codelineno-36-34" name="__codelineno-36-34" href="#__codelineno-36-34"></a>            <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-36-35"><a id="__codelineno-36-35" name="__codelineno-36-35" href="#__codelineno-36-35"></a>            <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="__span-36-36"><a id="__codelineno-36-36" name="__codelineno-36-36" href="#__codelineno-36-36"></a>        <span class="p">)</span>
</span><span id="__span-36-37"><a id="__codelineno-36-37" name="__codelineno-36-37" href="#__codelineno-36-37"></a>
</span><span id="__span-36-38"><a id="__codelineno-36-38" name="__codelineno-36-38" href="#__codelineno-36-38"></a>        <span class="c1"># MOVE TO VOLUME BLOCK TOP</span>
</span><span id="__span-36-39"><a id="__codelineno-36-39" name="__codelineno-36-39" href="#__codelineno-36-39"></a>        <span class="n">detection</span><span class="o">.</span><span class="n">move_based_on_detection</span><span class="p">(</span>
</span><span id="__span-36-40"><a id="__codelineno-36-40" name="__codelineno-36-40" href="#__codelineno-36-40"></a>            <span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">beam_type</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span><span class="p">,</span> <span class="n">move_x</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
</span><span id="__span-36-41"><a id="__codelineno-36-41" name="__codelineno-36-41" href="#__codelineno-36-41"></a>            <span class="n">_move_system</span><span class="o">=</span><span class="s2">&quot;manipulator&quot;</span>
</span><span id="__span-36-42"><a id="__codelineno-36-42" name="__codelineno-36-42" href="#__codelineno-36-42"></a>        <span class="p">)</span>
</span></code></pre></div>
<h4 id="step-11-attach-the-copper-block-to-the-volume">Step 11 - Attach the Copper Block to the Volume</h4>
<p>Once attached, we detect the copper adaptor interface, and mill the weld pattern.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="nt">liftout-weld</span><span class="p">:</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="w">    </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.5e-6</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="w">    </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5e-6</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="w">    </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4.0e-6</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="w">    </span><span class="nt">pitch_horizontal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.75e-6</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="w">    </span><span class="nt">n_columns</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="w">    </span><span class="nt">n_rows</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="w">    </span><span class="nt">pitch_vertical</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0e-6</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="w">    </span><span class="nt">rotation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="w">    </span><span class="nt">passes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="w">    </span><span class="nt">milling_voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0e+3</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="w">    </span><span class="nt">milling_current</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300.0e-12</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="w">    </span><span class="nt">hfw</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">150.0e-6</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="w">    </span><span class="nt">application_file</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autolamella&quot;</span>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="w">    </span><span class="nt">scan_direction</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;BottomToTop&quot;</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ArrayPattern&quot;</span>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a><span class="w">    </span><span class="nt">preset</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;30</span><span class="nv"> </span><span class="s">keV;</span><span class="nv"> </span><span class="s">2.5</span><span class="nv"> </span><span class="s">nA&quot;</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">VolumeBlockBottomEdge</span><span class="p">()</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">scan_rotation</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">VolumeBlockTopEdge</span><span class="p">()]</span> 
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="n">det</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">take_image_and_detect_features</span><span class="p">(</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>    <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>    <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>    <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="p">)</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="c1"># move the pattern to the top of the volume (i.e up by half the height of the pattern)</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="n">point</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">feature_m</span> 
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="n">point</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;milling&quot;</span><span class="p">][</span><span class="s2">&quot;liftout-weld&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="mf">5e-6</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> 
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a><span class="c1"># get weld milling stages</span>
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="n">stages</span> <span class="o">=</span> <span class="n">milling</span><span class="o">.</span><span class="n">get_milling_stages</span><span class="p">(</span><span class="s2">&quot;liftout-weld&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;milling&quot;</span><span class="p">],</span> <span class="n">point</span><span class="p">)</span>
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a>
</span><span id="__span-38-15"><a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a><span class="c1"># mill stages</span>
</span><span id="__span-38-16"><a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a><span class="n">milling</span><span class="o">.</span><span class="n">mill_stages</span><span class="p">(</span><span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span> <span class="n">stages</span><span class="o">=</span><span class="n">stages</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="step-12-14-sever-the-volume-block">Step 12 - 14 - Sever the Volume Block</h4>
<p>We mill the severing pattern as follows:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="nt">liftout-sever</span><span class="p">:</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="w">    </span><span class="nt">cleaning_cross_section</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="w">    </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0e-06</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="w">    </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5e-06</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="w">    </span><span class="nt">hfw</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">400.0e-6</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="w">    </span><span class="nt">milling_voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0e+3</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="w">    </span><span class="nt">milling_current</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0e-9</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="w">    </span><span class="nt">rotation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="w">    </span><span class="nt">scan_direction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TopToBottom</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="w">    </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50.0e-06</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="w">    </span><span class="nt">application_file</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autolamella&quot;</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Rectangle&quot;</span>
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a><span class="w">    </span><span class="nt">preset</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;30</span><span class="nv"> </span><span class="s">keV;</span><span class="nv"> </span><span class="s">20</span><span class="nv"> </span><span class="s">nA&quot;</span>
</span></code></pre></div>
<p>Detect the base of the volume block, and sever it from the sample.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="c1"># detect points in ion beam</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="mf">400e-6</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">VolumeBlockTopEdge</span><span class="p">()</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">scan_rotation</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">VolumeBlockBottomEdge</span><span class="p">()]</span> 
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="n">det</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">take_image_and_detect_features</span><span class="p">(</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>    <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>    <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a>    <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="p">)</span>
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a>
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="c1"># get the point</span>
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="n">point</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">feature_m</span> 
</span><span id="__span-40-13"><a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a>
</span><span id="__span-40-14"><a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a>
</span><span id="__span-40-15"><a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="c1"># get weld milling stages</span>
</span><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a><span class="n">stages</span> <span class="o">=</span> <span class="n">milling</span><span class="o">.</span><span class="n">get_milling_stages</span><span class="p">(</span><span class="s2">&quot;liftout-sever&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;milling&quot;</span><span class="p">],</span> <span class="n">point</span><span class="p">)</span>
</span><span id="__span-40-17"><a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a>
</span><span id="__span-40-18"><a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a><span class="c1"># mill stages</span>
</span><span id="__span-40-19"><a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a><span class="n">milling</span><span class="o">.</span><span class="n">mill_stages</span><span class="p">(</span><span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span> <span class="n">stages</span><span class="o">=</span><span class="n">stages</span><span class="p">)</span>
</span></code></pre></div>
<p>It is recommended by the authors to move the volume up slightly to check it is dettached from the sample. If not, repeat the severing.</p>
<h4 id="step-15-extract-the-volume-from-the-trench">Step 15 - Extract the Volume from the trench</h4>
<p>We slowly retract the volume from the sample plane. We use corrected movements to isolate this movement to the z-plane (dy in Ion)</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="c1"># retract slowly at first</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>    <span class="n">microscope</span><span class="o">.</span><span class="n">move_manipulator_corrected</span><span class="p">(</span><span class="n">dx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">beam_type</span><span class="o">=</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>        <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ref__manipulator_removal_slow_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>        <span class="n">eb_image</span><span class="p">,</span> <span class="n">ib_image</span> <span class="o">=</span> <span class="n">acquire</span><span class="o">.</span><span class="n">take_reference_images</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="c1"># then retract more</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="__span-41-11"><a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a>    <span class="n">microscope</span><span class="o">.</span><span class="n">move_manipulator_corrected</span><span class="p">(</span><span class="n">dx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mf">20e-6</span><span class="p">,</span> <span class="n">beam_type</span><span class="o">=</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span>
</span><span id="__span-41-12"><a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a>    <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ref__manipulator_removal_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-41-13"><a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a>    <span class="n">eb_image</span><span class="p">,</span> <span class="n">ib_image</span> <span class="o">=</span> <span class="n">acquire</span><span class="o">.</span><span class="n">take_reference_images</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</span><span id="__span-41-14"><a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="step-16-17-retract-the-manipulator">Step 16 - 17 - Retract the manipulator</h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="n">microscope</span><span class="o">.</span><span class="n">retract_manipulator</span><span class="p">()</span>
</span></code></pre></div>
<h2 id="landing">Landing</h2>
<p>The landing steps attach the lamella to the landing grid, and sever it from the rest of the volume block.</p>
<h3 id="step-1-setup-stage">Step 1 - Setup Stage</h3>
<p><em>"Move the stage to position the receiver grid in the field of view."</em></p>
<p>We can restore to a previously saved position, such a starting position by first saving it, and then restoring it by name.</p>
<p>To save and restore a position:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="c1">## save position</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="c1"># get the current stage position</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="n">stage_position</span> <span class="o">=</span> <span class="n">microscope</span><span class="o">.</span><span class="n">get_stage_position</span><span class="p">()</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="c1"># give your position a name</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="n">stage_position</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;my-position-grid-01&quot;</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="c1"># save position to positions.yaml</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="c1"># default path: fibsem/config/positions.yaml</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="n">utils</span><span class="o">.</span><span class="n">save_positions</span><span class="p">([</span><span class="n">stage_position</span><span class="p">])</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="c1">## restore position</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="c1"># you can restore these positions by loading the position by name:</span>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a><span class="n">stage_position</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_get_position</span><span class="p">(</span><span class="s2">&quot;my-position-grid-01&quot;</span><span class="p">)</span>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a>
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a><span class="c1"># move to position (safely)</span>
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a><span class="n">microscope</span><span class="o">.</span><span class="n">safe_absolute_stage_movement</span><span class="p">(</span><span class="n">stage_position</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="step-2-move-to-landing-orientation">Step 2 - Move to Landing Orientation</h3>
<p><em>"Set the stage to lamella milling orientation (0° relative rotation to loading angle, 18° stage tilt)
and adjust the stage rotation to make sure that the pins or 400 mesh grid bars are aligned
vertical."</em></p>
<p>We can restore to a previously defined position as shown before. In the autolamella application, the landing orientation is defined in the protocol as options/landing_start_position. You can define this position as shown above, or via the Movement Tab.</p>
<div class="language-yaml highlight"><span class="filename">protocol-serial-liftout.yaml</span><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="nt">options</span><span class="p">:</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w">    </span><span class="nt">landing_start_position</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pre-tilt-35-deg-grid-02-landing</span>
</span></code></pre></div>
<h3 id="step-3-setup-landing-positions">Step 3 - Setup Landing Positions</h3>
<p><em>"Set up the coincidence points for all positions to be used for section attachment. Place them in the middle of the field of view and save the positions. If corrections of rotation are necessary to have perfectly vertically running 400-mesh grid bars or pins, perform them during this step and save them with the stage positions. Note: assuming the receiver grid is perfectly loaded, saving a single coincidence point per row may suffice."</em></p>
<p>We will break this up into the following steps:</p>
<ol>
<li>Select initial landing position</li>
<li>Generate landing position grid</li>
</ol>
<p>We will generate a grid of landing positions, based on these protocol values.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="nt">options</span><span class="p">:</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w">    </span><span class="nt">landing_grid</span><span class="p">:</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w">        </span><span class="nt">x</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100.0e-6</span><span class="w">     </span><span class="c1"># grid spacing in x</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="w">        </span><span class="nt">y</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">400.0e-6</span><span class="w">     </span><span class="c1"># grid spacing in y</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">        </span><span class="nt">rows</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span><span class="w">         </span><span class="c1"># number of rows to generate</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w">        </span><span class="nt">cols</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w">        </span><span class="c1"># number of columns to generate</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="k">def</span> <span class="nf">generate_landing_positions</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">FibsemStagePositions</span><span class="p">]:</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a grid of landing positions starting at the top left corner. Positions are </span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="sd">    generated along the sample plane, based on the current orientation of the stage.&quot;&quot;&quot;</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>    <span class="c1"># base state = top left corner</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>    <span class="n">base_state</span> <span class="o">=</span> <span class="n">microscope</span><span class="o">.</span><span class="n">get_microscope_state</span><span class="p">()</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>    <span class="c1"># get the landing grid protocol</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>    <span class="n">landing_grid_protocol</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">][</span><span class="s2">&quot;landing_grid&quot;</span><span class="p">]</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a>    <span class="n">grid_square</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">landing_grid_protocol</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">landing_grid_protocol</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a>    <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">=</span> <span class="n">landing_grid_protocol</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">],</span> <span class="n">landing_grid_protocol</span><span class="p">[</span><span class="s1">&#39;cols&#39;</span><span class="p">]</span>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a>    <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a>
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rows</span><span class="p">):</span>
</span><span id="__span-46-16"><a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
</span><span id="__span-46-17"><a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a>            <span class="n">_new_position</span> <span class="o">=</span> <span class="n">microscope</span><span class="o">.</span><span class="n">project_stable_move</span><span class="p">(</span> 
</span><span id="__span-46-18"><a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a>                <span class="n">dx</span><span class="o">=</span><span class="n">grid_square</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">j</span><span class="p">,</span> 
</span><span id="__span-46-19"><a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a>                <span class="n">dy</span><span class="o">=-</span><span class="n">grid_square</span><span class="o">.</span><span class="n">y</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> 
</span><span id="__span-46-20"><a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a>                <span class="n">beam_type</span><span class="o">=</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">,</span> 
</span><span id="__span-46-21"><a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a>                <span class="n">base_position</span><span class="o">=</span><span class="n">base_state</span><span class="o">.</span><span class="n">stage_position</span><span class="p">)</span>            
</span><span id="__span-46-22"><a id="__codelineno-46-22" name="__codelineno-46-22" href="#__codelineno-46-22"></a>
</span><span id="__span-46-23"><a id="__codelineno-46-23" name="__codelineno-46-23" href="#__codelineno-46-23"></a>            <span class="c1"># position name is number of position in the grid</span>
</span><span id="__span-46-24"><a id="__codelineno-46-24" name="__codelineno-46-24" href="#__codelineno-46-24"></a>            <span class="n">_new_position</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Landing Position </span><span class="si">{</span><span class="n">i</span><span class="o">*</span><span class="n">n_cols</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-46-25"><a id="__codelineno-46-25" name="__codelineno-46-25" href="#__codelineno-46-25"></a>
</span><span id="__span-46-26"><a id="__codelineno-46-26" name="__codelineno-46-26" href="#__codelineno-46-26"></a>            <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_new_position</span><span class="p">)</span>
</span><span id="__span-46-27"><a id="__codelineno-46-27" name="__codelineno-46-27" href="#__codelineno-46-27"></a>
</span><span id="__span-46-28"><a id="__codelineno-46-28" name="__codelineno-46-28" href="#__codelineno-46-28"></a>    <span class="k">return</span> <span class="n">positions</span>
</span></code></pre></div>
<p>TODO: show generated grid</p>
<p>Once we have selected our initial landing position, we can generate this grid of landing positions as follows:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="c1"># user moves to initial landing position</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="n">initial_landing_position</span> <span class="o">=</span> 
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="c1"># generate landing positions</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="n">positions</span> <span class="o">=</span> <span class="n">generate_landing_positions</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="c1"># save landing positions to file</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="n">utils</span><span class="o">.</span><span class="n">save_positions</span><span class="p">(</span><span class="s2">&quot;path/to/saved-landing-positions.yaml&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>As these generated positions use the stable movement api (stage moves along the sample plane, coincidence is maintained), the positions should be relatively coincident across the entire grid. However, sample variation and damage to the grid can mean that the sample plane is not completely flat, breaking this assumption.</p>
<h3 id="step-4-move-to-landing-position">Step 4 - Move to Landing Position</h3>
<p>"<em>Go back to the first section attachment position"</em></p>
<p>This is the point we begin the landing workflow. The initial landing position is selected during setup, and then we use the generated landing position.  </p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="k">def</span> <span class="nf">create_lamella</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">experiment</span><span class="p">:</span> <span class="n">Experiment</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Lamella</span><span class="p">:</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new lamella object, ready for landing at the next available landing position&quot;&quot;&quot;</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>    <span class="c1"># create a new lamella </span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>    <span class="n">num</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>    <span class="n">lamella</span> <span class="o">=</span> <span class="n">Lamella</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a>    <span class="c1"># get the number of previously landed lamella</span>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a>    <span class="n">_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">experiment</span><span class="o">.</span><span class="n">positions</span><span class="p">])</span>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>    <span class="n">land_idx</span> <span class="o">=</span> <span class="n">_counter</span><span class="p">[</span><span class="n">AutoLamellaStage</span><span class="o">.</span><span class="n">LandLamella</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a>
</span><span id="__span-48-12"><a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a>    <span class="c1"># set the state of the lamella, ready for landing</span>
</span><span id="__span-48-13"><a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a>    <span class="n">lamella</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">AutoLamellaStage</span><span class="o">.</span><span class="n">LiftoutLamella</span>
</span><span id="__span-48-14"><a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a>    <span class="n">lamella</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">microscope_state</span> <span class="o">=</span> <span class="n">microscope</span><span class="o">.</span><span class="n">get_microscope_state</span><span class="p">()</span>
</span><span id="__span-48-15"><a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a>    <span class="n">lamella</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">microscope_state</span><span class="o">.</span><span class="n">stage_position</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">land_idx</span><span class="p">])</span>
</span><span id="__span-48-16"><a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a>    <span class="n">lamella</span><span class="o">.</span><span class="n">landing_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">lamella</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">microscope_state</span><span class="p">)</span>
</span><span id="__span-48-17"><a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a>
</span><span id="__span-48-18"><a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a>    <span class="k">return</span> <span class="n">lamella</span>
</span><span id="__span-48-19"><a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a>
</span><span id="__span-48-20"><a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a><span class="k">def</span> <span class="nf">landing_workflow</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">experiment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Experiment</span><span class="p">:</span>
</span><span id="__span-48-21"><a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a>
</span><span id="__span-48-22"><a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a>    <span class="c1"># generated positions</span>
</span><span id="__span-48-23"><a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a>    <span class="n">positions</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_get_positions</span><span class="p">(</span><span class="s2">&quot;path/to/saved-landing-positions.yaml&quot;</span><span class="p">)</span>
</span><span id="__span-48-24"><a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a>
</span><span id="__span-48-25"><a id="__codelineno-48-25" name="__codelineno-48-25" href="#__codelineno-48-25"></a>    <span class="c1"># continue landing until exhausted</span>
</span><span id="__span-48-26"><a id="__codelineno-48-26" name="__codelineno-48-26" href="#__codelineno-48-26"></a>    <span class="n">continue_landing</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-48-27"><a id="__codelineno-48-27" name="__codelineno-48-27" href="#__codelineno-48-27"></a>
</span><span id="__span-48-28"><a id="__codelineno-48-28" name="__codelineno-48-28" href="#__codelineno-48-28"></a>    <span class="k">while</span> <span class="n">continue_landing</span><span class="p">:</span>
</span><span id="__span-48-29"><a id="__codelineno-48-29" name="__codelineno-48-29" href="#__codelineno-48-29"></a>
</span><span id="__span-48-30"><a id="__codelineno-48-30" name="__codelineno-48-30" href="#__codelineno-48-30"></a>        <span class="c1"># create a new lamella position</span>
</span><span id="__span-48-31"><a id="__codelineno-48-31" name="__codelineno-48-31" href="#__codelineno-48-31"></a>        <span class="n">lamella</span> <span class="o">=</span> <span class="n">create_lamella</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">experiment</span><span class="p">,</span> <span class="n">positions</span><span class="p">)</span>
</span><span id="__span-48-32"><a id="__codelineno-48-32" name="__codelineno-48-32" href="#__codelineno-48-32"></a>
</span><span id="__span-48-33"><a id="__codelineno-48-33" name="__codelineno-48-33" href="#__codelineno-48-33"></a>        <span class="c1"># land lamella</span>
</span><span id="__span-48-34"><a id="__codelineno-48-34" name="__codelineno-48-34" href="#__codelineno-48-34"></a>        <span class="n">lamella</span> <span class="o">=</span> <span class="n">land_lamella</span><span class="p">(</span>
</span><span id="__span-48-35"><a id="__codelineno-48-35" name="__codelineno-48-35" href="#__codelineno-48-35"></a>            <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-48-36"><a id="__codelineno-48-36" name="__codelineno-48-36" href="#__codelineno-48-36"></a>            <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-48-37"><a id="__codelineno-48-37" name="__codelineno-48-37" href="#__codelineno-48-37"></a>            <span class="n">lamella</span><span class="o">=</span><span class="n">lamella</span><span class="p">,</span>
</span><span id="__span-48-38"><a id="__codelineno-48-38" name="__codelineno-48-38" href="#__codelineno-48-38"></a>        <span class="p">)</span>
</span><span id="__span-48-39"><a id="__codelineno-48-39" name="__codelineno-48-39" href="#__codelineno-48-39"></a>
</span><span id="__span-48-40"><a id="__codelineno-48-40" name="__codelineno-48-40" href="#__codelineno-48-40"></a>        <span class="c1"># continue with landing if user confirms, and enough material</span>
</span><span id="__span-48-41"><a id="__codelineno-48-41" name="__codelineno-48-41" href="#__codelineno-48-41"></a>        <span class="n">continue_landing</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-48-42"><a id="__codelineno-48-42" name="__codelineno-48-42" href="#__codelineno-48-42"></a>            <span class="n">ask_user</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Continue Landing?&quot;</span><span class="p">)</span> <span class="ow">and</span>
</span><span id="__span-48-43"><a id="__codelineno-48-43" name="__codelineno-48-43" href="#__codelineno-48-43"></a>            <span class="n">validate_volume_block_size</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="__span-48-44"><a id="__codelineno-48-44" name="__codelineno-48-44" href="#__codelineno-48-44"></a>        <span class="p">)</span>
</span></code></pre></div>
<h3 id="step-5-insert-manipulator">Step 5 - Insert Manipulator</h3>
<p><em>"Re-insert the needle to which the extracted volume is attached."</em></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c1"># insert manipulator to park position (high above landing grid)</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="n">microscope</span><span class="o">.</span><span class="n">insert_manipulator</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;PARK&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="step-6-">Step 6 -</h3>
<p><em>"Lower the needle so that the extracted volume is about 10 µm above the first position."</em></p>
<p>We break this down into the following steps:</p>
<ol>
<li>Detect the bottom of the volume block, and the centre of the landing grid. Landing grid refers to the individual landing grid we intend to land on.</li>
<li>Set an offset of 10um between these two points</li>
<li>Move the manipulator by the distance between these two points.</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1"># detect points in ion beam at low mag</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="mf">400e-6</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">VolumeBlockBottomEdge</span><span class="p">(),</span> <span class="n">LandingGridCentre</span><span class="p">()]</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="n">det</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">take_image_and_detect_features</span><span class="p">(</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>    <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>    <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>    <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="p">)</span>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="c1"># set the offset y=10um</span>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a><span class="n">det</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">10e-6</span><span class="p">)</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a>
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="c1"># move based on detection</span>
</span><span id="__span-50-15"><a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a><span class="n">detection</span><span class="o">.</span><span class="n">move_based_on_detection</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">beam_type</span><span class="o">=</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="step-7-position-extraction-volume">Step 7 - Position Extraction Volume</h3>
<p><em>"Position the extracted volume using the SEM channel.
a. For double-sided attachment, adjust y to align the leading edge of the volume with the
previously milled line pattern and adjust x to place the volume precisely between the
two grid bars. "</em></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="c1"># detect points in electron beam at low mag</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="mf">150e-6</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ELECTRON</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">VolumeBlockBottomEdge</span><span class="p">(),</span> <span class="n">LandingGridCentre</span><span class="p">()]</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="n">det</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">take_image_and_detect_features</span><span class="p">(</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>    <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>    <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>    <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="p">)</span>
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="c1"># move based on detection</span>
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="n">detection</span><span class="o">.</span><span class="n">move_based_on_detection</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">beam_type</span><span class="o">=</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ELECTRON</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="step-8-lower-extraction-volume">Step 8 - Lower Extraction Volume</h3>
<p><em>"Lower the extraction volume into place by adjusting z. Use the FIB channel as guidance.
Double-check intermittently for alignment with line/corner landmarks using the SEM channel.
a. For double sided attachment:
i. If the extraction volume is too wide to fit between the grid bars, mill off excess
material using regular cross sections or patterns (30kV, 300 pA). The extracted
volume should fit close to perfectly into the mesh.
ii. Align the lower front edge of the extraction volume with the previously milled
line.</em>"</p>
<p>We break this down into the following steps:</p>
<ol>
<li>Check the size of the volume block and the landing grid.</li>
<li>If larger, mill the sides away. If not, continue.</li>
<li>Detect the bottom edge of the volume block, and the centre of the landing grid.</li>
<li>Move the manipulator down based on the detection (z-axis only).</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="c1"># check volume block size</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="c1"># see if wider than grid bars gap </span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="c1"># TODO:</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="c1"># detect points in electron beam at low mag</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="mf">150e-6</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">VolumeBlockBottomEdge</span><span class="p">(),</span> <span class="n">LandingGridCentre</span><span class="p">()]</span>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="n">det</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">take_image_and_detect_features</span><span class="p">(</span>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a>    <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a>    <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a>    <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a><span class="p">)</span>
</span><span id="__span-52-14"><a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a>
</span><span id="__span-52-15"><a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a><span class="c1"># move based on detection</span>
</span><span id="__span-52-16"><a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a><span class="n">detection</span><span class="o">.</span><span class="n">move_based_on_detection</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">move_x</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">beam_type</span><span class="o">=</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="step-9-landing-attachment">Step 9 - Landing Attachment</h3>
<p><em>"Attach the extracted volume to the grid bars by redposition milling. Place the milling start of the patterns at on the interface of the grid bar and extraction volume."</em></p>
<p><em>"For double-sided attachment mill on both adjacent grid bars for attachment. Mill a vertical array of regular cross-sections (single pass, width 4.0 µm, height 0.5 µm, zdepth 10 µm, vertical spacing 0.25 µm, 30 kV, 1 nA) directed away from the extracted volume."</em></p>
<p>We break this down into the following steps:</p>
<ol>
<li>Detect corners of the volume block</li>
<li>Offset them by the height we want our lamella</li>
<li>Get milling stages from protocol</li>
<li>Mill the welds</li>
</ol>
<p>First we need to define our weld milling protocol. We already support these kind of milling patterns, under the type "Spot Weld". A spot weld consists of a set of equally horizontal patterns, and is used as the name suggests for redeposition welds. Similar to attaching the  volume block to the adapter, setting passes = 1 is important so we don't mill over our redeposited material.</p>
<div class="language-yaml highlight"><span class="filename">protocol-serial-liftout.yaml</span><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="nt">landing-weld</span><span class="p">:</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="w">    </span><span class="nt">stages</span><span class="p">:</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="w">    </span><span class="c1"># left weld</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5e-6</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="w">        </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4.0e-6</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="w">        </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0e-6</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="w">        </span><span class="nt">pitch_vertical</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.25e-6</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="w">        </span><span class="nt">n_rows</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="w">        </span><span class="nt">n_columns</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="w">        </span><span class="nt">pitch_horizontal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="w">        </span><span class="nt">rotation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a><span class="w">        </span><span class="nt">passes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="w">        </span><span class="nt">milling_current</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300.0e-12</span>
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a><span class="w">        </span><span class="nt">milling_voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0e-9</span>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a><span class="w">        </span><span class="nt">hfw</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">150.0e-6</span>
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a><span class="w">        </span><span class="nt">application_file</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autolamella&quot;</span>
</span><span id="__span-53-17"><a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a><span class="w">        </span><span class="nt">scan_direction</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;RightToLeft&quot;</span>
</span><span id="__span-53-18"><a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ArrayPattern&quot;</span>
</span><span id="__span-53-19"><a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a><span class="w">    </span><span class="c1"># right weld</span>
</span><span id="__span-53-20"><a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w">   </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5e-6</span>
</span><span id="__span-53-21"><a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a><span class="w">        </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4.0e-6</span>
</span><span id="__span-53-22"><a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a><span class="w">        </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0e-6</span>
</span><span id="__span-53-23"><a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a><span class="w">        </span><span class="nt">pitch_vertical</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.25e-6</span>
</span><span id="__span-53-24"><a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a><span class="w">        </span><span class="nt">n_rows</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
</span><span id="__span-53-25"><a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a><span class="w">        </span><span class="nt">n_columns</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-53-26"><a id="__codelineno-53-26" name="__codelineno-53-26" href="#__codelineno-53-26"></a><span class="w">        </span><span class="nt">pitch_horizontal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-53-27"><a id="__codelineno-53-27" name="__codelineno-53-27" href="#__codelineno-53-27"></a><span class="w">        </span><span class="nt">rotation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span id="__span-53-28"><a id="__codelineno-53-28" name="__codelineno-53-28" href="#__codelineno-53-28"></a><span class="w">        </span><span class="nt">passes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
</span><span id="__span-53-29"><a id="__codelineno-53-29" name="__codelineno-53-29" href="#__codelineno-53-29"></a><span class="w">        </span><span class="nt">milling_current</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300.0e-12</span>
</span><span id="__span-53-30"><a id="__codelineno-53-30" name="__codelineno-53-30" href="#__codelineno-53-30"></a><span class="w">        </span><span class="nt">milling_voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0e-9</span>
</span><span id="__span-53-31"><a id="__codelineno-53-31" name="__codelineno-53-31" href="#__codelineno-53-31"></a><span class="w">        </span><span class="nt">hfw</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">150.0e-6</span>
</span><span id="__span-53-32"><a id="__codelineno-53-32" name="__codelineno-53-32" href="#__codelineno-53-32"></a><span class="w">        </span><span class="nt">application_file</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autolamella&quot;</span>
</span><span id="__span-53-33"><a id="__codelineno-53-33" name="__codelineno-53-33" href="#__codelineno-53-33"></a><span class="w">        </span><span class="nt">scan_direction</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;LeftToRight&quot;</span>
</span><span id="__span-53-34"><a id="__codelineno-53-34" name="__codelineno-53-34" href="#__codelineno-53-34"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ArrayPattern&quot;</span>
</span></code></pre></div>
<p>This protocol gives us the following milling patterns.</p>
<p>We can now write the code for detecting the corners, offseting the patterns, and milling the welds.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="c1"># detect points in ion beam</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">VolumeBlockBottomLeftCorner</span><span class="p">(),</span> <span class="n">VolumeBlockBottomRightCorner</span><span class="p">()]</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="n">det</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">take_image_and_detect_features</span><span class="p">(</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a>    <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>    <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a>    <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="p">)</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a><span class="c1"># get the points</span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="n">left_corner</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">feature_m</span> 
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a><span class="n">right_corner</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">feature_m</span>
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a>
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a><span class="c1"># add some offset in y</span>
</span><span id="__span-54-15"><a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a><span class="n">v_offset</span> <span class="o">=</span> <span class="mf">2e-6</span>  <span class="c1"># half of recommended 4um height (step 11)</span>
</span><span id="__span-54-16"><a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a><span class="n">left_corner</span><span class="o">.</span><span class="n">y</span>  <span class="o">+=</span>  <span class="n">v_offset</span>
</span><span id="__span-54-17"><a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a><span class="n">right_corner</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span>  <span class="n">v_offset</span>
</span><span id="__span-54-18"><a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a>
</span><span id="__span-54-19"><a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a><span class="c1"># get weld milling stages</span>
</span><span id="__span-54-20"><a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a><span class="n">stages</span> <span class="o">=</span> <span class="n">milling</span><span class="o">.</span><span class="n">get_milling_stages</span><span class="p">(</span><span class="s2">&quot;weld&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="p">[</span><span class="n">left_point</span><span class="p">,</span> <span class="n">right_point</span><span class="p">])</span>
</span><span id="__span-54-21"><a id="__codelineno-54-21" name="__codelineno-54-21" href="#__codelineno-54-21"></a>
</span><span id="__span-54-22"><a id="__codelineno-54-22" name="__codelineno-54-22" href="#__codelineno-54-22"></a><span class="c1"># mill stages</span>
</span><span id="__span-54-23"><a id="__codelineno-54-23" name="__codelineno-54-23" href="#__codelineno-54-23"></a><span class="n">milling</span><span class="o">.</span><span class="n">mill_stages</span><span class="p">(</span><span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span> <span class="n">stages</span><span class="o">=</span><span class="n">stages</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="step-10-move-manipulator">Step 10 - Move Manipulator</h3>
<p><em>"Move the needle up by a step of 50-100 nm to create strain."</em></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1"># move manipulator up 50-100 nm to create strain</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="n">dy</span> <span class="o">=</span> <span class="mf">100e-9</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="n">microscope</span><span class="o">.</span><span class="n">move_manipulator_corrected</span><span class="p">(</span><span class="n">dx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">beam_type</span><span class="o">=</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="step-11-release-section">Step 11 - Release Section</h3>
<p><em>"Release the section by milling a line pattern across the extracted volume at the desired sectioning distance from the lower edge of the extracted volume (30kV, 1 nA, z-depth 20 µm). Sectioning at 4 µm is recommended to begin with, but sections down to 1 µm can be obtained."</em></p>
<p>We break this down into the following steps:</p>
<ol>
<li>Detect bottom edge of the volume block</li>
<li>Offset them by the height we want our lamella</li>
<li>Get milling stages from protocol</li>
<li>Mill the sever</li>
</ol>
<p>Milling protocol</p>
<div class="language-yaml highlight"><span class="filename">protocol-serial-liftout.yaml</span><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="nt">landing-sever</span><span class="p">:</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="w">    </span><span class="nt">cleaning_cross_section</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="w">    </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20.0e-06</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="w">    </span><span class="nt">height</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.25e-06</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="w">    </span><span class="nt">hfw</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">150.0e-6</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="w">    </span><span class="nt">milling_current</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0e-09</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="w">    </span><span class="nt">milling_voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30.0e+3</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="w">    </span><span class="nt">rotation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a><span class="w">    </span><span class="nt">scan_direction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LeftToRight</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="w">    </span><span class="nt">width</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50.0e-06</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="w">    </span><span class="nt">application_file</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;autolamella&quot;</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Rectangle&quot;</span><span class="w"> </span><span class="c1"># TODO: change to Line</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="c1"># detect points, in ion beam</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">VolumeBlockBottomEdge</span><span class="p">()]</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="n">det</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">take_image_and_detect_features</span><span class="p">(</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>    <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>    <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>    <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="p">)</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="c1"># add some offset in y</span>
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="n">v_offset</span> <span class="o">=</span> <span class="mf">4e-6</span>  <span class="c1"># recommended 4um height </span>
</span><span id="__span-57-12"><a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a><span class="n">point</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">feature_m</span>
</span><span id="__span-57-13"><a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a><span class="n">point</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">v_offset</span>
</span><span id="__span-57-14"><a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a>
</span><span id="__span-57-15"><a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a><span class="c1"># get weld milling stages</span>
</span><span id="__span-57-16"><a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a><span class="n">stages</span> <span class="o">=</span> <span class="n">milling</span><span class="o">.</span><span class="n">get_milling_stages</span><span class="p">(</span><span class="s2">&quot;landing-sever&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>
</span><span id="__span-57-17"><a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a>
</span><span id="__span-57-18"><a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a><span class="c1"># mill stages</span>
</span><span id="__span-57-19"><a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a><span class="n">milling</span><span class="o">.</span><span class="n">mill_stages</span><span class="p">(</span><span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span> <span class="n">stages</span><span class="o">=</span><span class="n">stages</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="step-12-validate-release">Step 12 - Validate Release</h3>
<p><em>"Check whether the section has been released by moving the needle up by 1-3 steps of 50 nm.
If the section moves with the needle, repeat the line pattern milling."</em></p>
<p>We break this down into the following steps</p>
<ol>
<li>Move the manipulator up by 50-100nm.</li>
<li>Detect the bottom edge of the volume block, and the top edge of the lamella.</li>
<li>Measure the distance between these points</li>
<li>If the distance is greater than threshold continue. If not, repeat the milling.</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="n">confirm_sever</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="k">while</span> <span class="n">confirm_sever</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>    <span class="c1"># Step 11 - Mill Sever </span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>    <span class="c1"># HERE</span>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>    <span class="c1"># move the manipulator up a small amount</span>
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a>        <span class="n">microscope</span><span class="o">.</span><span class="n">move_manipulator_corrected</span><span class="p">(</span><span class="n">dx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mf">50e-9</span><span class="p">,</span> <span class="n">beam_type</span><span class="o">=</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span>
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a>
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a>    <span class="c1"># detect the distance between volume block and lamella</span>
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a>    <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span>
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a>    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">VolumeBlockBottomEdge</span><span class="p">(),</span> <span class="n">LamellaTopEdge</span><span class="p">()]</span>
</span><span id="__span-58-14"><a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a>    <span class="n">det</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">take_image_and_detect_features</span><span class="p">(</span>
</span><span id="__span-58-15"><a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a>        <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-58-16"><a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a>        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-58-17"><a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a>        <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="__span-58-18"><a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a>    <span class="p">)</span>
</span><span id="__span-58-19"><a id="__codelineno-58-19" name="__codelineno-58-19" href="#__codelineno-58-19"></a>
</span><span id="__span-58-20"><a id="__codelineno-58-20" name="__codelineno-58-20" href="#__codelineno-58-20"></a>    <span class="c1"># check if the distance is greater than threshold </span>
</span><span id="__span-58-21"><a id="__codelineno-58-21" name="__codelineno-58-21" href="#__codelineno-58-21"></a>    <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.5e-6</span>
</span><span id="__span-58-22"><a id="__codelineno-58-22" name="__codelineno-58-22" href="#__codelineno-58-22"></a>    <span class="n">confirm_sever</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
</span><span id="__span-58-23"><a id="__codelineno-58-23" name="__codelineno-58-23" href="#__codelineno-58-23"></a>
</span><span id="__span-58-24"><a id="__codelineno-58-24" name="__codelineno-58-24" href="#__codelineno-58-24"></a><span class="c1"># Step 13 - Move Manipulator up</span>
</span></code></pre></div>
<h3 id="step-13-move-manipulator-up">Step 13 - Move Manipulator Up</h3>
<p><em>"Once the section is released, carefully maneuver the extraction volume up. As soon as there is some distance to the section (~1 µm), increase the step size or jog. Move the volume up
slightly below the edge of the FIB image in lowest magnification"</em></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="c1"># move up slowly</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="n">dy</span> <span class="o">=</span> <span class="mf">100e-9</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>    <span class="n">microscope</span><span class="o">.</span><span class="n">move_manipulator_corrected</span><span class="p">(</span><span class="n">dx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">beam_type</span><span class="o">=</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="c1"># move up</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="n">microscope</span><span class="o">.</span><span class="n">move_manipulator_corrected</span><span class="p">(</span><span class="n">dx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mf">100e-6</span><span class="p">,</span> <span class="n">beam_type</span><span class="o">=</span><span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span><span class="p">)</span> <span class="c1"># question: is this too much force?</span>
</span></code></pre></div>
<h3 id="step-14-retract-manipulator">Step 14 - Retract Manipulator</h3>
<p><em>"Retract the needle"</em>.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="c1"># retract the manipulator</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="n">microscope</span><span class="o">.</span><span class="n">retract_manipulator</span><span class="p">()</span>
</span></code></pre></div>
<h3 id="step-15-repeat">Step 15 - Repeat</h3>
<p>*"Move the stage to the next section attachment position and continue from step 5. Repeat this, until the extracted volume has been completely sectioned."</p>
<p>At this point we would end our workflow stage, and continue to the next landing position to repeat the next landing.</p>
<p>We also need to develop an automated stopping condition, to determine when the "volume has been completely sectioned". Again we can use the model to measure the remaining volume.</p>
<p>We break down this down into the following steps:</p>
<ol>
<li>Assume the manipulator is inserted, or we are at a position where we can see the entire volume block. For example, at the start of the landing workflow after the manipulator is inserted.</li>
<li>Detect the bounding box of the volume block.</li>
<li>Measure the size of the volume block bounding box</li>
<li>If the size is above a threshold, we continue to land more. If below, the volume block has been exhausted, and we need to clean the adapter and reset.</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="k">def</span> <span class="nf">validate_volume_block_size</span><span class="p">(</span><span class="n">microscope</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates if the volume block has enough material to continue landing&quot;&quot;&quot;</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>    <span class="c1"># detect volume block features at low mag in ion beam</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>    <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">hfw</span> <span class="o">=</span> <span class="mf">400e-6</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>    <span class="n">settings</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_type</span> <span class="o">=</span> <span class="n">BeamType</span><span class="o">.</span><span class="n">ION</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a>    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">VolumeBlockTopEdge</span><span class="p">(),</span> <span class="n">VolumeBlockBottomEdge</span><span class="p">()]</span>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a>    <span class="n">det</span> <span class="o">=</span> <span class="n">detection</span><span class="o">.</span><span class="n">take_image_and_detect_features</span><span class="p">(</span>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>        <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span>
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a>        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span>
</span><span id="__span-61-11"><a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a>        <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
</span><span id="__span-61-12"><a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a>    <span class="p">)</span>
</span><span id="__span-61-13"><a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a>
</span><span id="__span-61-14"><a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a>    <span class="c1"># get distance</span>
</span><span id="__span-61-15"><a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a>    <span class="n">volume_block_height</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">det</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="c1"># distance between features</span>
</span><span id="__span-61-16"><a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a>
</span><span id="__span-61-17"><a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a>    <span class="c1"># check threshold</span>
</span><span id="__span-61-18"><a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a>    <span class="n">threshold</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">protocol</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;minimum_volume_size&quot;</span><span class="p">,</span> <span class="mf">10e-6</span><span class="p">)</span>
</span><span id="__span-61-19"><a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a>
</span><span id="__span-61-20"><a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a>    <span class="n">continue_landing</span>
</span><span id="__span-61-21"><a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a>    <span class="k">if</span> <span class="n">volume_block_height</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="__span-61-22"><a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a>        <span class="n">continue_landing</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-61-23"><a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a>
</span><span id="__span-61-24"><a id="__codelineno-61-24" name="__codelineno-61-24" href="#__codelineno-61-24"></a>    <span class="k">return</span> <span class="n">continue_landing</span>
</span></code></pre></div>
<h2 id="section-thinning">Section Thinning</h2>
<p>After this point, you can use the standard autolamella workflow to thin and polish your lamella. If you ran serial liftout through the user interface, it will automatically prompt you to continue the workflow. All the landing positions are saved, and assoicated so you can quickly setup your thinning patterns and continue.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.expand", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.indexes", "content.code.copy"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>